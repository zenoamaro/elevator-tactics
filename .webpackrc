const path = require('path');
const webpack = require('webpack');
const WebpackShellPlugin = require('webpack-shell-plugin');
const development = process.env.NODE_ENV === 'development';
function d(dir) { return path.resolve(__dirname, dir); }

module.exports = {

	entry: {
		scripts: development? [
			'webpack-dev-server/client?http://localhost:8080/',
			'webpack/hot/only-dev-server',
			'react-hot-loader/patch',
			'babel-polyfill',
			d('src/index.js'),
		] : [
			'babel-polyfill',
			d('src/index.js'),
		],
	},

	devtool: development
		? "cheap-module-source-map"
		: "hidden-source-map",

	resolve: {
		extensions: [ '.js', '.jsx', '.json' ],
		modules: [ 'src', 'node_modules' ],
	},

	module: {
		loaders: [{
			test: /\.json$/,
			loaders: ['json'],
		}, {
			test: /\.(html|css|jpg|png|svg|pdf)$/,
			include: d('src/renderer'),
			loaders: ['file'],
			query: { context:'./src/renderer',
							 name:'[path][name].[ext]?[hash:10]' },
		}, {
			test: /\.(html|css|jpg|png|svg|pdf)$/,
			include: d('src/bundle'),
			loaders: ['file'],
			query: { context:'./src/bundle',
							 name:'[path][name].[ext]?[hash:10]' },
		}, {
			test: /\.jsx?$/,
			include: d('src'),
			loaders: ['babel'],
		}]
	},

	node: {
		fs: "empty"
	},

	devServer: {
		noInfo: false,
		hot: development,
		historyApiFallback: true,
		contentBase: d('dist'),
		publicPath: 'http://localhost:8080/',
		stats: { chunks: false },
	},

	output: {
		path: d('dist'),
		pathinfo: development,
		filename: '[name].js',
		publicPath: development
			? 'http://localhost:8080/'
			: '/',
	},

	plugins: [
		new webpack.NoErrorsPlugin(),
		new webpack.EnvironmentPlugin(['NODE_ENV']),
		new webpack.LoaderOptionsPlugin({
			debug: development,
			minimize: !false,
		}),
	].concat(development? [
		new webpack.HotModuleReplacementPlugin(),
		new WebpackShellPlugin({
			'onBuildStart': "open 'http://localhost:8080'",
		}),
	] : [
		new webpack.optimize.DedupePlugin(),
		new webpack.optimize.UglifyJsPlugin({
			comments: /\/\/#/, // Keep only source maps
			compress: { warnings: false },
		}),
	]),

};
